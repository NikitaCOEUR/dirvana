#!/usr/bin/env fish
# Fish completions

function __dirvana_complete_fish
  # Get the current command line (all tokens except current word being completed)
  set -l cmd (commandline -opc)

  # Get the current token being completed
  set -l current_token (commandline -ct)

  # For dirvana completion, we need all words including the current (partial) token
  # If current token is empty, we're completing a new word after a space
  set -l words $cmd
  if test -n "$current_token"
    set -a words $current_token
  else
    # Add empty string for new word completion
    set -a words ""
  end

  # Count words to determine COMP_CWORD (0-based index)
  set -l cword (math (count $words) - 1)

  # Call dirvana completion with all words from command line
  set -l suggestions (env DIRVANA_SHELL=fish DIRVANA_COMP_CWORD=$cword dirvana completion -- $words 2>/dev/null)

  # Check if we got any suggestions
  if test (count $suggestions) -eq 0
    # Fallback to file completion
    return 1
  end

  # Parse suggestions (format: value\tdescription)
  for suggestion in $suggestions
    # Split by tab to separate value and description
    set -l parts (string split \t $suggestion)

    if test (count $parts) -eq 2
      # Has description
      echo $parts[1]\t$parts[2]
    else
      # No description
      echo $suggestion
    end
  end
end

# Register completion function for the alias
complete -c %s -f -a '(__dirvana_complete_fish)'
